// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
  relationMode = "prisma"
}

// ========================================
// USER MANAGEMENT
// ========================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}



// ========================================
// PRODUCT MANAGEMENT (Stock-Only)
// ========================================

model Product {
  id                String   @id @default(cuid())
  name              String
  unit              String
  stockQuantity     Float    @default(0) @map("stock_quantity")
  minimumStockLevel Float    @default(0) @map("minimum_stock_level")
  allowNegativeStock Boolean @default(false) @map("allow_negative_stock")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  purchaseItems  PurchaseItem[]
  saleItems      SaleItem[]
  stockMovements StockMovement[]

  @@index([isActive])
  @@map("products")
}



// ========================================
// VENDOR MANAGEMENT
// ========================================

model Vendor {
  id             String   @id @default(cuid())
  name           String
  phone          String?
  address        String?
  balance        Float    @default(0) @map("balance")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  purchases    Purchase[]
  payments     Payment[]
  transactions Transaction[]

  @@index([isActive])
  @@map("vendors")
}

// ========================================
// CUSTOMER MANAGEMENT
// ========================================

model Customer {
  id             String   @id @default(cuid())
  name           String
  phone          String?
  address        String?
  balance        Float    @default(0) @map("balance")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  sales        Sale[]
  payments     Payment[]
  transactions Transaction[]

  @@index([isActive])
  @@map("customers")
}

// ========================================
// PURCHASE MANAGEMENT
// ========================================

model Purchase {
  id            String   @id @default(cuid())
  vendorId      String   @map("vendor_id")
  invoiceNumber String   @unique @map("invoice_number")
  purchaseDate  DateTime @map("purchase_date")
  subtotal      Float    @default(0) @map("subtotal")
  additionalCharges Float @default(0) @map("additional_charges")
  chargesDescription String? @map("charges_description")
  totalAmount   Float    @map("total_amount")
  paidAmount    Float    @default(0) @map("paid_amount")
  dueAmount     Float    @map("due_amount")
  notes         String?
  isOpeningBalance Boolean @default(false) @map("is_opening_balance")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  vendor       Vendor         @relation(fields: [vendorId], references: [id])
  items        PurchaseItem[]
  transactions Transaction[]
  paymentHistory PaymentHistory[]

  @@index([vendorId])
  @@index([purchaseDate])
  @@index([invoiceNumber])
  @@map("purchases")
}

model PurchaseItem {
  id         String   @id @default(cuid())
  purchaseId String   @map("purchase_id")
  productId  String   @map("product_id")
  quantity   Float    
  unitPrice  Float    @map("unit_price")
  totalPrice Float    @map("total_price")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id])

  @@index([purchaseId])
  @@index([productId])
  @@map("purchase_items")
}

// ========================================
// SALES MANAGEMENT
// ========================================

model Sale {
  id            String   @id @default(cuid())
  customerId    String?  @map("customer_id")
  invoiceNumber String   @unique @map("invoice_number")
  saleDate      DateTime @map("sale_date")
  subtotal      Float    @default(0) @map("subtotal")
  additionalCharges Float @default(0) @map("additional_charges")
  chargesDescription String? @map("charges_description")
  totalAmount   Float    @map("total_amount")
  paidAmount    Float    @default(0) @map("paid_amount")
  dueAmount     Float    @map("due_amount")
  notes         String?
  isWalkIn      Boolean  @default(false) @map("is_walk_in")
  walkInCustomerName String? @map("walk_in_customer_name")
  isOpeningBalance Boolean @default(false) @map("is_opening_balance")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  customer     Customer?     @relation(fields: [customerId], references: [id])
  items        SaleItem[]
  transactions Transaction[]
  paymentHistory PaymentHistory[]

  @@index([customerId])
  @@index([saleDate])
  @@index([invoiceNumber])
  @@map("sales")
}

model SaleItem {
  id         String   @id @default(cuid())
  saleId     String   @map("sale_id")
  productId  String   @map("product_id")
  quantity   Float    
  unitPrice  Float    @map("unit_price")
  totalPrice Float    @map("total_price")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
}

// ========================================
// PAYMENT & TRANSACTION SYSTEM
// ========================================

model Payment {
  id              String      @id @default(cuid())
  partyType       String      @map("party_type")
  vendorId        String?     @map("vendor_id")
  customerId      String?     @map("customer_id")
  amount          Float
  paymentMode     String      @map("payment_mode")
  referenceNumber String?     @map("reference_number")
  paymentDate     DateTime    @map("payment_date")
  notes           String?
  createdAt       DateTime    @default(now()) @map("created_at")

  // Relations
  vendor      Vendor?      @relation(fields: [vendorId], references: [id])
  customer    Customer?    @relation(fields: [customerId], references: [id])
  transaction Transaction?

  @@index([vendorId])
  @@index([customerId])
  @@index([paymentDate])
  @@map("payments")
}



// ========================================
// TRANSACTION LEDGER (Complete Audit Trail)
// ========================================

model Transaction {
  id              String          @id @default(cuid())
  transactionType String          @map("transaction_type")

  // Party Information
  vendorId   String? @map("vendor_id")
  customerId String? @map("customer_id")

  // Reference Information
  purchaseId String? @unique @map("purchase_id")
  saleId     String? @unique @map("sale_id")
  paymentId  String? @unique @map("payment_id")

  // Transaction Details
  amount          Float
  balanceBefore   Float    @map("balance_before")
  balanceAfter    Float    @map("balance_after")
  description     String
  transactionDate DateTime @map("transaction_date")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  vendor   Vendor?   @relation(fields: [vendorId], references: [id])
  customer Customer? @relation(fields: [customerId], references: [id])
  purchase Purchase? @relation(fields: [purchaseId], references: [id])
  sale     Sale?     @relation(fields: [saleId], references: [id])
  payment  Payment?  @relation(fields: [paymentId], references: [id])

  @@index([vendorId])
  @@index([customerId])
  @@index([transactionDate])
  @@index([transactionType])
  @@map("transactions")
}

// ========================================
// PAYMENT HISTORY (Track payments per invoice)
// ========================================

model PaymentHistory {
  id          String   @id @default(cuid())
  
  // Link to transaction
  saleId      String?  @map("sale_id")
  purchaseId  String?  @map("purchase_id")
  
  // Payment details
  amount      Float
  paymentMode String   @map("payment_mode")
  paymentDate DateTime @map("payment_date")
  notes       String?
  
  // Balance tracking
  balanceBefore Float  @map("balance_before")
  balanceAfter  Float  @map("balance_after")
  
  createdAt   DateTime @default(now()) @map("created_at")
  createdBy   String?  @map("created_by")

  // Relations
  sale     Sale?     @relation(fields: [saleId], references: [id], onDelete: Cascade)
  purchase Purchase? @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([purchaseId])
  @@index([paymentDate])
  @@map("payment_history")
}



// ========================================
// STOCK MOVEMENT TRACKING
// ========================================

model StockMovement {
  id            String       @id @default(cuid())
  productId     String       @map("product_id")
  movementType  String       @map("movement_type")
  quantity      Float
  balanceBefore Float        @map("balance_before")
  balanceAfter  Float        @map("balance_after")
  referenceType String?      @map("reference_type")
  referenceId   String?      @map("reference_id")
  notes         String?
  createdAt     DateTime     @default(now()) @map("created_at")

  // Relations
  product Product @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([movementType])
  @@index([createdAt])
  @@map("stock_movements")
}


